---
import Layout from '../../layouts/Layout.astro';
import { getCollection, render } from 'astro:content';
import { getMediaUrl } from '../../config';

export async function getStaticPaths() {
  const projects = await getCollection('projects');
  return projects.map((project) => ({
    params: { slug: project.id },
    props: { project },
  }));
}

const { project } = Astro.props;
const { Content } = await render(project);

const formatDate = (dateString: string) => {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', {
    year: 'numeric',
    month: 'long'
  });
};

// Helper to get thumbnail for a media item
function getThumb(item: { type: 'image' | 'video'; url: string; poster?: string }): string {
  if (item.type === 'video') {
    return getMediaUrl(item.poster || '/images/video-placeholder.jpg');
  }
  return getMediaUrl(item.url);
}

const firstMedia = project.data.media[0];
---

<Layout title={project.data.title} description={`${project.data.title} - A remodeling project by Grey Oak Remodel in Colorado.`}>
  <div class="page-header">
    <div class="container">
      <a href="/portfolio" class="back-link">&larr; Back to Portfolio</a>
      <h1>{project.data.title}</h1>
      <div class="project-meta">
        <span>{formatDate(project.data.date)}</span>
        {project.data.location && <span>{project.data.location}</span>}
      </div>
    </div>
  </div>

  <section class="section">
    <div class="container">
      <div class="project-layout">
        <div class="project-gallery">
          <div class="gallery">
            <div class="gallery-main" id="gallery-main">
              {firstMedia?.type === 'video' ? (
                <video
                  controls
                  playsinline
                  preload="metadata"
                  poster={firstMedia.poster ? getMediaUrl(firstMedia.poster) : undefined}
                  id="main-video"
                >
                  <source src={getMediaUrl(firstMedia.url)} type="video/mp4" />
                  Your browser does not support the video tag.
                </video>
              ) : (
                <img
                  src={firstMedia ? getMediaUrl(firstMedia.url) : '/images/placeholder.jpg'}
                  alt={project.data.title}
                  id="main-image"
                />
              )}
            </div>
            {project.data.media.length > 1 && (
              <div class="gallery-thumbs">
                {project.data.media.map((item, index) => (
                  <button
                    class:list={["gallery-thumb", { active: index === 0 }]}
                    data-type={item.type}
                    data-src={getMediaUrl(item.url)}
                    data-poster={item.poster ? getMediaUrl(item.poster) : ''}
                    data-index={index}
                  >
                    <img src={getThumb(item)} alt={`${project.data.title} - ${index + 1}`} />
                    {item.type === 'video' && <span class="thumb-video-icon">â–¶</span>}
                  </button>
                ))}
              </div>
            )}
          </div>
        </div>

        <div class="project-content">
          <div class="project-tags">
            {project.data.tags.map((tag) => (
              <span class="tag">{tag}</span>
            ))}
          </div>

          <div class="project-description">
            <Content />
          </div>

          <div class="project-cta">
            <h3>Planning something similar?</h3>
            <p>We'd love to hear about your project.</p>
            <a href="/contact" class="btn btn-primary">Get a Free Consultation</a>
          </div>
        </div>
      </div>
    </div>
  </section>
</Layout>

<script>
  const galleryMain = document.getElementById('gallery-main');
  const thumbs = document.querySelectorAll('.gallery-thumb');

  thumbs.forEach(thumb => {
    thumb.addEventListener('click', () => {
      const type = thumb.getAttribute('data-type');
      const src = thumb.getAttribute('data-src');
      const poster = thumb.getAttribute('data-poster');

      if (!galleryMain || !src) return;

      // Update active state
      thumbs.forEach(t => t.classList.remove('active'));
      thumb.classList.add('active');

      // Replace main content
      if (type === 'video') {
        galleryMain.innerHTML = `
          <video controls playsinline preload="metadata" ${poster ? `poster="${poster}"` : ''}>
            <source src="${src}" type="video/mp4" />
            Your browser does not support the video tag.
          </video>
        `;
      } else {
        galleryMain.innerHTML = `<img src="${src}" alt="Project image" />`;
      }
    });
  });
</script>

<style>
  .back-link {
    display: inline-block;
    color: var(--color-text-muted);
    font-size: 0.9375rem;
    margin-bottom: var(--space-sm);
    transition: color 0.2s ease;
  }

  .back-link:hover {
    color: var(--color-accent);
  }

  .project-layout {
    display: grid;
    gap: var(--space-xl);
  }

  @media (min-width: 1024px) {
    .project-layout {
      grid-template-columns: 1.5fr 1fr;
      align-items: start;
    }
  }

  .gallery {
    display: grid;
    gap: var(--space-sm);
  }

  .gallery-main {
    aspect-ratio: 16 / 10;
    border-radius: 8px;
    overflow: hidden;
    background-color: var(--color-bg-alt);
  }

  .gallery-main img,
  .gallery-main video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .gallery-main video {
    object-fit: contain;
    background-color: #000;
  }

  .gallery-thumbs {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: var(--space-xs);
  }

  .gallery-thumb {
    position: relative;
    aspect-ratio: 1;
    border-radius: 4px;
    overflow: hidden;
    cursor: pointer;
    opacity: 0.7;
    transition: opacity 0.2s ease;
    border: 2px solid transparent;
    padding: 0;
    background: none;
  }

  .gallery-thumb:hover,
  .gallery-thumb.active {
    opacity: 1;
  }

  .gallery-thumb.active {
    border-color: var(--color-accent);
  }

  .gallery-thumb img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .thumb-video-icon {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background-color: rgba(0, 0, 0, 0.6);
    color: white;
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    padding-left: 2px;
  }

  .project-description {
    margin: var(--space-lg) 0;
    line-height: 1.7;
  }

  .project-description :global(p) {
    margin-bottom: var(--space-md);
    color: var(--color-text);
  }

  .project-cta {
    background-color: var(--color-bg-alt);
    padding: var(--space-lg);
    border-radius: 8px;
    margin-top: var(--space-lg);
  }

  .project-cta h3 {
    margin-bottom: var(--space-xs);
  }

  .project-cta p {
    color: var(--color-text-muted);
    margin-bottom: var(--space-md);
  }
</style>
